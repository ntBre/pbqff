changequote(`{{', `}}')dnl
changecom()dnl

define({{tolower}}, {{translit($1, {{A-Z}}, {{a-z}})}})
define({{make_id}}, {{translit(tolower($1), {{ }}, {{-}})}})

define({{head2}}, {{<h2 id=make_id($1)><a href="#make_id($1)">$1</a></h2>}})
define({{head3}}, {{<h3 id=make_id($1)><a href="#make_id($1)">$1</a></h3>}})
define({{code_block}}, {{<pre><code>include($1)</code></pre>}})
define({{csv_table}}, {{syscmd({{./tables/convert.awk $1}})}})

<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pbqff: push-button quartic force fields</title>
	<style>
	  body {
		  width:60%;
		  margin-left: auto;
		  margin-right: auto;
	  }
	  pre {
		  word-wrap: normal;
		  overflow-x: auto;
		  background-color: rgb(245, 245, 245);
		  padding: 10px;
	  }
	  table {
		  border-collapse: collapse;
		  border: 2px solid rgb(140 140 140);
		  font-family: sans-serif;
		  font-size: 0.8rem;
		  letter-spacing: 1px;
	  }
	  caption {
		  caption-side: bottom;
		  padding: 10px;
		  font-weight: bold;
	  }
	  th, td {
		  padding: 8px 10px;
		  text-align: left;
	  }
	  h2 a, h3 a {
		  text-decoration: none;
		  color: inherit;
	  }
	  h2 a:hover, h3 a:hover {
		  text-decoration: underline;
	  }
	</style>
  </head>
  <body>
	<h1>pbqff</h1>

	<p>
	  This page contains the complete documentation for pbqff as a single HTML
	  page. For a quick reference see
	  the <a href="https://github.com/ntBre/pbqff/tree/master/man">man</a>
	  directory in the main repository, where you can find a manual page in both
	  Unix <code>man</code> and PDF formats.
	</p>

	<h2>Table of Contents</h2>
	include(toc.html)

	head2(Introduction)

	<p>
	  pbqff is a package (really a collection of packages) for computing
	  anharmonic vibrational and rotational spectroscopic constants for small
	  molecules. It does this through the use of quartic force fields (QFFs) to
	  approximate the molecular potential energy function and second-order
	  vibrational and rotational perturbation theory, which utilize the
	  derivative information from the function approximation to compute the
	  actual spectroscopic constants.
	</p>

	<p>
	  Because this is a complex task, pbqff is broken into several reusable
	  components, only the final piece of which is included in this repository.
	  Other major components include:
	</p>

	<ul>
	  <li>
		<a href="https://github.com/ntBre/symm">symm</a> for the
		main <code>Molecule</code> data structure and symmetry operations
	  </li>
	  <li>
		<a href="https://github.com/ntBre/psqs">psqs</a> for interfaces to
		quantum chemistry programs and distributed queuing systems
	  </li>
	  <li>
		<a href="https://github.com/ntBre/spectro">spectro</a> for the final
		spectroscopic calculations
	  </li>
	</ul>

	<p>
	  pbqff itself is a relatively thin wrapper around these packages that
	  primarily handles tasks like generating the grid of displaced geometries
	  to map out the QFF in various coordinate systems. This fact isn't really
	  important directly, but it may help to explain some of the potential error
	  messages you encounter, if they reference source code
	  in <code>psqs</code>, for example.
	</p>

	head2(Program Input)

	<p>
	  The primary input for pbqff is a <a href="https://toml.io/en/">TOML</a>
	  file. TOML as a format is widely used in the Rust community and is pretty
	  easy for humans to write, although you will end up having to type a lot of
	  quotes compared to something like YAML. To start, here's an example input
	  file for a <a href="https://github.com/openmopac/mopac">MOPAC</a> QFF on a
	  PBS queue:
	</p>

	code_block({{examples/mopac_pbs.toml}})

	<p>
	  In addition to the options specified here, there are a few other optional
	  values like <code>hybrid_template</code> for specifying a separate quantum
	  chemistry program template for the cubic and quartic force
	  constants, <code>weights</code> for specifying atomic
	  weights, <code>dummy_atoms</code> for specifying a number of trailing
	  dummy atoms, and the very specialized <code>norm_resume_hff</code> for
	  resuming a normal coordinate QFF from the finished Cartesian harmonic
	  force field (HFF). A summary of all the possible input options is given in
	  the table below, followed by a more detailed description of each option.
	</p>

	<table>
	  <caption>Summary of input options</caption>
	  <tr>
		<th>Option</th>
		<th>Type</th>
		<th>Description</th>
	  </tr>
	  <tr>
		<td><code>geometry</code></td>
		<td>String</td>
		<td>The initial molecular geometry as XYZ or Z-matrix</td>
	  </tr>
	  <tr>
		<td><code>optimize</code></td>
		<td>bool</td>
		<td>Whether or not to optimize the geometry before running the QFF</td>
	  </tr>
	  <tr>
		<td><code>charge</code></td>
		<td>isize</td>
		<td>The molecular charge</td>
	  </tr>
	  <tr>
		<td><code>step_size</code></td>
		<td>f64</td>
		<td>The displacement size for the QFF</td>
	  </tr>
	  <tr>
		<td><code>sleep_int</code></td>
		<td>usize</td>
		<td>Interval in seconds to sleep between job polling iterations</td>
	  </tr>
	  <tr>
		<td><code>job_limit</code></td>
		<td>usize</td>
		<td>Maximum number of jobs to submit to the queue at once</td>
	  </tr>
	  <tr>
		<td><code>chunk_size</code></td>
		<td>usize</td>
		<td>Number of jobs to combine into a single queue submission</td>
	  </tr>
	  <tr>
		<td><code>coord_type</code></td>
		<td>CoordType</td>
		<td>Displacement type for the QFF. Supported values are sic, cart, and
		norm</td>
	  </tr>
	  <tr>
		<td><code>template</code></td>
		<td>TemplateSrc</td>
		<td>Quantum chemistry program template. Can either be a literal String
		or a map with the key <code>file</code></td>
	  </tr>
	  <tr>
		<td><code>hybrid_template</code></td>
		<td> Option&lt;TemplateSrc&gt;</td>
		<td>Separate quantum chemistry program template for cubic and quartic
		force constants</td>
	  </tr>
	  <tr>
		<td><code>queue_template</code></td>
		<td> Option&lt;TemplateSrc&gt;</td>
		<td>Queuing system template</td>
	  </tr>
	  <tr>
		<td><code>program</code></td>
		<td>Program</td>
		<td>A quantum chemistry program name. Supported values are dftb+, mopac,
		molpro, and cfour</td>
	  </tr>
	  <tr>
		<td><code>queue</code></td>
		<td> Queue</td>
		<td>A queuing system. Supported values are pbs, slurm, and local</td>
	  </tr>
	  <tr>
		<td><code>findiff</code></td>
		<td> Option&lt;bool&gt;</td>
		<td>Whether to use finite differences for derivative evaluations. Not
		all coordinate types support this</td>
	  </tr>
	  <tr>
		<td><code>check_int</code></td>
		<td>usize</td>
		<td>Interval in polling iterations to write checkpoints. A value of 0
		disables checkpoints</td>
	  </tr>
	  <tr>
		<td><code>weights</code></td>
		<td> Option&lt;Vec&lt;f64&gt;&gt;</td>
		<td>An optional sequence of atomic masses for use in normal coordinate
		QFFs and spectroscopic calculations</td>
	  </tr>
	  <tr>
		<td><code>dummy_atoms</code></td>
		<td> Option&lt;usize&gt;</td>
		<td>An optional number of trailing dummy atoms</td>
	  </tr>
	  <tr>
		<td><code>norm_resume_hff</code></td>
		<td>Option&lt;bool&gt;</td>
		<td>Resume a normal coordinate QFF from a previously-finished HFF
		checkpoint</td>
	  </tr>
	</table>

	head3(Geometry Specification and Optimization)

	<p>
	  The <code>geometry</code> can be specified as either an XYZ geometry with
	  an optional number of atoms and comment line or as a Z-matrix. Currently,
	  pbqff cannot automatically convert between Z-matrix and XYZ geometries,
	  so <code>optimize = true</code> is required if the geometry is provided as
	  a Z-matrix. This allows pbqff to extract the Cartesian geometry from the
	  quantum chemistry program's output file and use that for the geometrical
	  displacements. For completeness, here is an example XYZ geometry for
	  cyclopropenylidene:
	</p>

	code_block(examples/c3h2.xyz)

	<p>
	  Again, the first two lines are optional, but if either one is present then
	  both must be present. And an example Z-matrix geometry for water:
	</p>

	code_block(examples/water.zmat)

	<p>
	  Aside from the caveats above about Z-matrix input,
	  the <code>optimize</code> keyword tells pbqff whether or not to optimize
	  the geometry before building the rest of the QFF. Because the quality of
	  the Taylor series approximation underlying the QFF is tied to the
	  assumption that the input geometry is a minimum on the potential energy
	  surface, any geometries provided with <code>optimize = false</code> should
	  definitely have been optimized prior to the pbqff run and at the same
	  level of theory as the QFF.
	</p>

	head3(Charge)

	<p>
	  <code>charge</code> is possibly the most straightforward input option as
	  it is simply the molecular charge as a whole number. As we'll see in later
	  sections, this won't necessarily be used if you omit
	  a <code>{{{{.charge}}}}</code> entry in your program template, but the
	  option must be provided in the pbqff input file even in those cases.
	</p>

	head3(Step Size)

	<p>
	</p>

	head3(Sleep Interval)

	<p>
	</p>

	head3(Job Limit and Chunk Size)

	<p>
	</p>

	head3(Coordinate Types)

	<p>
	</p>

	head3(Quantum Chemistry Program Types)

	<p>
	</p>

	head3(Queue Types)

	<p>
	</p>

	head3(Quantum Chemistry Program Templates)

	<p>
	</p>

	head3(Queue Templates)

	<p>
	</p>

	head3(Derivative Types)

	<p>
	</p>

	head3(Checkpoints)

	<p>
	</p>

	head3(Atomic Masses)

	<p>
	</p>

	head3(Dummy Atoms)

	<p>
	</p>

	head3(Resuming Normal Coordinate QFFs)

	<p>
	</p>

	head2(Command Line Options)

	<p>
	  In addition to the settings in the input file described in the previous
	  section, pbqff takes several command line options. To some extent, the
	  most important of these is the name of the input file, but even this has a
	  default value of <code>pbqff.toml</code>, allowing it to be omitted if you
	  use that as your input file name. The other options are summarized in the
	  table below.
	</p>

	<table>
	  <caption>Summary of command line options</caption>
	  csv_table(tables/cli.csv)
	</table>

	<p>
	  As indicated by the slash, each of these options can either be provided as
	  a short option with a single dash and its first letter or as a long option
	  with two dashes and the full name.
	</p>

	<p>
	  Of these options, <code>-t/--threads</code> is probably the most important
	  on a regular basis since it controls the number of threads spawned by
	  pbqff. If you're running pbqff on a local computer, you may want to limit
	  this to ~half of the CPUs on the machine to allow other programs to run
	  smoothly. Otherwise, if you're running pbqff on some kind of HPC cluster,
	  you'll likely want to set this to the number of CPUs you request in your
	  job submission script.
	</p>

	<p>
	  The <code>-o/--overwrite</code> option is also commonly used, especially
	  if you make a typo in your first submission of a pbqff job. By default,
	  pbqff will refuse to overwrite any output files in the current directory,
	  even if they just contain an error message. Passing the <code>-o</code>
	  flag will bypass this check and allow the run to continue.
	</p>

	<p>
	  The <code>-c/--checkpoint</code> flag can be used to resume from a
	  previously-written checkpoint file. See
	  the <a href="#checkpoints">Checkpoints</a> section above for more details.
	</p>

	<p>
	  Finally, the <code>-n/--no_del</code> option prevents pbqff from cleaning
	  up the (sometimes numerous) single-point energy input and output files as
	  it runs. This is primarily useful if you're debugging some kind of issue
	  in pbqff and need to see all of the output files at the end of a run. This
	  is not the default because large QFFs produce a very large quantity of
	  very similar files that HPC administrators don't always like to keep
	  around.
	</p>

	<p>
	  As noted in the table, the <code>-j/--json</code> flag is intended
	  primarily for use by qffbuddy and is hidden from the
	  built-in <code>-h/--help</code> flag contained in pbqff. However, it is
	  documented here in case it proves useful for other interfaces to pbqff.
	</p>

  </body>
</html>
